name: iOS Build

on:
  push:
    branches:
      - main
      - master
    paths:
      - lib/**
      - ios/**
      - pubspec.yaml
      - pubspec.lock
      - .github/workflows/ios-build.yml
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build mode"
        required: true
        default: unsigned
        type: choice
        options:
          - unsigned
          - signed
      export_method:
        description: "Only used for signed builds"
        required: true
        default: ad-hoc
        type: choice
        options:
          - ad-hoc
          - app-store
      flutter_version:
        description: "Flutter version"
        required: true
        default: 3.38.5
        type: string

jobs:
  ios-build:
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ github.event.inputs.flutter_version || '3.38.5' }}
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Install Dart/Flutter dependencies
        run: flutter pub get

      - name: Inject iOS Firebase plist (optional)
        env:
          IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 }}
        run: |
          if [ -n "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
            echo "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > ios/Runner/GoogleService-Info.plist
            echo "GoogleService-Info.plist injected."
          else
            echo "No Firebase plist secret provided; skipping injection."
          fi

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Build iOS unsigned IPA
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_type == 'unsigned' }}
        run: flutter build ipa --release --no-codesign

      - name: Validate signing secrets
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'signed' }}
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          missing=0
          for key in IOS_CERTIFICATE_BASE64 IOS_CERTIFICATE_PASSWORD IOS_MOBILEPROVISION_BASE64 IOS_KEYCHAIN_PASSWORD; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: Install signing certificate and provisioning profile
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'signed' }}
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/ios_signing_certificate.p12"
          PROFILE_PATH="$RUNNER_TEMP/ios_profile.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > "$CERT_PATH"
          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > "$PROFILE_PATH"

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/"

      - name: Build iOS signed IPA
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'signed' }}
        run: flutter build ipa --release --export-method ${{ github.event.inputs.export_method }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ github.run_number }}
          path: |
            build/ios/ipa/*.ipa
            build/ios/iphoneos/*.app
          if-no-files-found: warn
